<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>Sticky Notes</title>

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
  <link href="main.css" rel="stylesheet">
</head>

<body>
  <div class="navbar navbar-inverse bg-inverse">
    <div class="container d-flex justify-content-between">
      <a href="#" class="navbar-brand">Sticky Notes</a>
    </div>
  </div>

  <section class="jumbotron text-center">
    <div class="container">
      <h1 class="jumbotron-heading">CivicPlus JavaScript Class Notes!</h1>
      <p class="lead text-muted">Saving the world one tree at a time!</p>
      <p>
        <a href="#" class="btn btn-primary">Add a note</a>
      </p>
    </div>
  </section>

  <div style="display: none;" id="noteCloner">
    <div class="note"  data-note-id="">
      <div class="note-header">
        <h5 class="modal-title">Note</h5>
      </div>
      <div class="note-body">
        <p class="note-text" contenteditable="true" id="myText">Note text</p>
      </div>
      <div class="note-footer">
        <button type="button" class="close" aria-label="Delete">
                <span aria-hidden="true" class="fa fa-trash-o text-danger"></span>
            </button>
      </div>
    </div>
  </div>

  <div class="board text-muted">
    <div class="container">
      <div class="row">


      </div>
    </div>
  </div>

  <footer class="text-muted">
    <div class="container">
      <p class="float-right">
        <a href="#">Back to top</a>
      </p>
      <p>&copy; Salvum Ligna Inc.</p>
    </div>
  </footer>
  <script>
    (function() {

      loadNotes();


      function loadNotes()
      {
        let gReq = new XMLHttpRequest();
        gReq.open("GET", "/api/notes");
        gReq.setRequestHeader("Content-Type", "application/json");
        gReq.onload = function(){
          let notes = JSON.parse(this.responseText);

          for(var x = 0; x < notes.length; x++)
          {
            makeANote(notes[x].note, notes[x]._id);
          }
        }
        gReq.send(null);
      }



      let newText = document.querySelector("#myText");
      newText.addEventListener("blur", function() {
        console.log("Im here");
        addNote(newText.TextContent);
      });


      function addNote(note, noteNode) {
        let oReq = new XMLHttpRequest();
        oReq.open("POST", "/api/notes");
        oReq.setRequestHeader("Content-Type", "application/json");

        let noteObject = {
          note: note
        };
        oReq.onload = function()
        {
          noteNode.dataset.noteId = JSON.parse(this.responseText)._id;
        }
        let payload = JSON.stringify(noteObject);
        oReq.send(payload);
      }

      let addNoteButton = document.querySelector(".btn-primary");
      addNoteButton.addEventListener("click", function() {
        let noteOrignal = document.querySelector("#noteCloner").firstElementChild;
        let noteClone = noteOrignal.cloneNode(true);
        let p = noteClone.querySelector("p");
        p.addEventListener("blur", function() {
          console.log("Im here");
          addNote(this.textContent, noteClone);
        });

        let row = document.querySelector(".row");
        row.append(noteClone);


      });

      function makeANote(contentIn, id)
      {
        let noteOrignal = document.querySelector("#noteCloner").firstElementChild;
        let noteClone = noteOrignal.cloneNode(true);
        noteClone.dataset.noteId = id;
        let content = noteClone.querySelector("p");
        content.textContent = contentIn;

        let deleteIcon = document.querySelectorAll("[aria-label='Delete']");
        deleteIcon.addEventListener("click", deleteNote(id));
        //need to add event for updating
        let row = document.querySelector(".row");
        row.append(noteClone);

      }

      function deleteNote(id)
      {
        fetchSite("DELETE", id, null, null);
        event.srcElement.parentElement.remove(event.srcElement);
      }

      function fetchSite(method, noteid, callback, payload)
      {
        let oReq = new XMLHttpRequest();
        oReq.open(method, "/api/notes/" + noteid);
        oReq.setRequestHeader("Content-Type", "application/json");

        oReq.onload = function()
        {
          callback;
        }

        oReq.send(payload);
      }

      //add note "POST", create
      //update note "PUT", update
      //delete note "DELETE", delete
      //read notes "GET", read
//when you load notes you should probably add event listerners add update and DELETE

//method GET (loading all - read), PUT (for update), DELETE, POST (ADD), callback,
//fetchsite(method, callback, payload)
//{
//oreq = onload = calback;
//}

// fetch() catch api something fancy


//JSON.parse / to put into objects
//xhr.open("DELETE", "api/notes/59937a630d3e8c001110a85f")
// put is to update




    })();
  </script>
</body>

</html>
